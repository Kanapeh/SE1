# ุฑุงูููุง ุฑูุน ุฎุทุง PKCE ุฏุฑ OAuth

## ูุดฺฉู ฺุณุชุ

ุฎุทุง `invalid request: both auth code and code verifier should be non-empty` ูุดุงูโุฏููุฏู ูุดฺฉู ุฏุฑ ุฌุฑุงู PKCE (Proof Key for Code Exchange) ุงุณุช. ุงู ุฎุทุง ุฒูุงู ุฑุฎ ูโุฏูุฏ ฺฉู:

1. **ฺฉุฏ ุงุญุฑุงุฒ ููุช (Authorization Code)** ุฏุฑุงูุช ุดุฏู ุงูุง **ฺฉุฏ ุชุงุฏ (Code Verifier)** ุฏุฑ ุฏุณุชุฑุณ ูุณุช
2. **ุฒูุงูโุจูุฏ ูุงุฏุฑุณุช** ุฏุฑ ุฌุฑุงู OAuth
3. **ูพุงฺฉ ุดุฏู ูุงุฏุฑุณุช** storage ฺฉู ุดุงูู PKCE state ุงุณุช

## ุฑุงูโุญูโูุง ุงุนูุงู ุดุฏู

### 1. ุจูุจูุฏ ูุฏุฑุช PKCE ุฏุฑ `app/auth/complete/page.tsx`

- **ุชุดุฎุต ุฎุทุงูุง PKCE**: ุดูุงุณุง ุฎุทุงูุง ูุฑุจูุท ุจู code verifier
- **ุฑูุด ุฌุงฺฏุฒู**: ุชูุงุด ุจุฑุง ุฏุฑุงูุช session ุจู ุตูุฑุช ูุณุชูู
- **ูฺฉุงูุฒู retry**: ุชูุงุด ูุฌุฏุฏ ุจุง ุชุงุฎุฑ ุฒูุงู ููุงุณุจ
- **ุดูููุฏู ุชุบุฑุงุช auth**: ุงุณุชูุงุฏู ุงุฒ `onAuthStateChange` ุจุฑุง ุชุดุฎุต ุชุบุฑุงุช

### 2. ุจูุจูุฏ ูุฏุฑุช Storage ุฏุฑ `lib/supabase.ts`

- **ุญูุธ PKCE state**: ุนุฏู ูพุงฺฉ ฺฉุฑุฏู PKCE verifier ุฏุฑ ุญู ุฌุฑุงู
- **ูพุงฺฉ ฺฉุฑุฏู ุงูุชุฎุงุจ**: ูพุงฺฉ ฺฉุฑุฏู storage ุจู ุฌุฒ PKCE state
- **ุชุงุจุน ุฌุฏุฏ**: `clearPKCEState()` ุจุฑุง ูพุงฺฉ ฺฉุฑุฏู PKCE ูพุณ ุงุฒ ุงุญุฑุงุฒ ููุช ูููู

### 3. ุจูุจูุฏ ุฌุฑุงู OAuth ุฏุฑ `app/login/page.tsx`

- **ุชุงุฎุฑ ุฏุฑ ูพุงฺฉ ฺฉุฑุฏู storage**: ุงุฌุงุฒู ุฏุงุฏู ุจู PKCE ุจุฑุง ุชุซุจุช
- **ูุฏุฑุช ุจูุชุฑ ุฎุทุงูุง**: ุชุดุฎุต ู ูุฏุฑุช ุฎุทุงูุง PKCE

## ูุญูู ุงุณุชูุงุฏู

### 1. ุชุณุช ุฌุฑุงู PKCE

ุจู ุตูุญู `/test-pkce` ุจุฑูุฏ ุชุง ุจุชูุงูุฏ:
- ูุถุนุช PKCE storage ุฑุง ูุดุงูุฏู ฺฉูุฏ
- ุฌุฑุงู OAuth ุฑุง ุชุณุช ฺฉูุฏ
- ุฎุทุงูุง ุฑุง debug ฺฉูุฏ

### 2. ุจุฑุฑุณ Console

ุฏุฑ Developer Tools ูุฑูุฑฺฏุฑุ ุจู ุฏูุจุงู ูพุงูโูุง ุฒุฑ ุจุงุดุฏ:
- `๐ Completing PKCE authentication...`
- `๐ Exchanging authorization code for session...`
- `โ Code exchange successful` ุง ุฎุทุงูุง ูุฑุจูุทู

### 3. ูพุงฺฉ ฺฉุฑุฏู Storage

ุงฺฏุฑ ูุดฺฉู ุงุฏุงูู ุฏุงุดุช:
```javascript
// ุฏุฑ console ูุฑูุฑฺฏุฑ
localStorage.clear();
sessionStorage.clear();
// ุณูพุณ ุตูุญู ุฑุง refresh ฺฉูุฏ
```

## ุชูุธูุงุช Supabase

### 1. ุงุทููุงู ุงุฒ ูุนุงู ุจูุฏู PKCE

ุฏุฑ Supabase Dashboard:
- **Authentication > Settings > Auth Providers > Google**
- **PKCE** ุจุงุฏ ูุนุงู ุจุงุดุฏ
- **Redirect URL** ุจุงุฏ ุฏูู ุจุงุดุฏ

### 2. ุชูุธูุงุช Google OAuth

ุฏุฑ Google Cloud Console:
- **Authorized redirect URIs** ุจุงุฏ ุดุงูู:
  ```
  https://your-project.supabase.co/auth/v1/callback
  ```

## ุนุจโุงุจ

### ุฎุทุง "code verifier should be non-empty"

**ุนูุช**: PKCE state ูพุงฺฉ ุดุฏู ุง ุชุซุจุช ูุดุฏู
**ุฑุงูโุญู**: 
1. ุตูุญู ุฑุง refresh ฺฉูุฏ
2. ุฏูุจุงุฑู OAuth ุฑุง ุงูุชุญุงู ฺฉูุฏ
3. storage ุฑุง ูพุงฺฉ ฺฉูุฏ ู ุฏูุจุงุฑู ุชูุงุด ฺฉูุฏ

### ุฎุทุง "invalid request"

**ุนูุช**: ูุดฺฉู ุฏุฑ ุชุจุงุฏู ฺฉุฏ
**ุฑุงูโุญู**:
1. ุจุฑุฑุณ console ุจุฑุง ุฌุฒุฆุงุช ุจุดุชุฑ
2. ุงุทููุงู ุงุฒ ุตุญุช redirect URL
3. ุชุณุช ุจุง ูุฑูุฑฺฏุฑ incognito

### ุนุฏู ุฏุฑุงูุช session

**ุนูุช**: ูุดฺฉู ุฏุฑ ุฌุฑุงู PKCE
**ุฑุงูโุญู**:
1. ุงุณุชูุงุฏู ุงุฒ ุตูุญู debug `/test-pkce`
2. ุจุฑุฑุณ network tab ุฏุฑ Developer Tools
3. ุงุทููุงู ุงุฒ ูุนุงู ุจูุฏู Google OAuth ุฏุฑ Supabase

## ูฺฉุงุช ููู

1. **PKCE flow** ูุงุฒ ุจู ุญูุธ state ุฏุฑ ูุฑูุฑฺฏุฑ ุฏุงุฑุฏ
2. **Storage clearing** ูุจุงุฏ ุฏุฑ ุญู ุฌุฑุงู OAuth ุงูุฌุงู ุดูุฏ
3. **Redirect URLs** ุจุงุฏ ุฏูู ู ุตุญุญ ุจุงุดูุฏ
4. **Environment variables** ุจุงุฏ ุจู ุฏุฑุณุช ุชูุธู ุดุฏู ุจุงุดูุฏ

## ุชุณุช ููุง

ูพุณ ุงุฒ ุงุนูุงู ุชุบุฑุงุช:

1. ุจู ุตูุญู `/test-pkce` ุจุฑูุฏ
2. OAuth ุฑุง ุชุณุช ฺฉูุฏ
3. console ุฑุง ุจุฑุง ุฎุทุงูุง ุจุฑุฑุณ ฺฉูุฏ
4. ุงฺฏุฑ ูููู ุจูุฏุ ุจู ุตูุญู ุงุตู login ุจุฑูุฏ ู ุชุณุช ฺฉูุฏ

## ุฏุฑ ุตูุฑุช ุงุฏุงูู ูุดฺฉู

ุงฺฏุฑ ูุดฺฉู ููฺูุงู ุงุฏุงูู ุฏุงุดุช:

1. **Supabase logs** ุฑุง ุจุฑุฑุณ ฺฉูุฏ
2. **Network requests** ุฑุง ุฏุฑ Developer Tools ุจุฑุฑุณ ฺฉูุฏ
3. **Browser compatibility** ุฑุง ุจุฑุฑุณ ฺฉูุฏ
4. **Supabase version** ุฑุง ุจูโุฑูุฒุฑุณุงู ฺฉูุฏ
