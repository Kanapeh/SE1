# راهنمای راه‌اندازی سیستم نظرات

## مراحل راه‌اندازی

### 1. به‌روزرسانی جدول نظرات موجود

فایل `database/update_comments_table.sql` را در Supabase SQL Editor اجرا کنید تا فیلدهای `name`، `email` و `ip_address` به جدول موجود اضافه شوند.

**نکته:** جدول `comments` شما از قبل وجود دارد و فقط نیاز به اضافه کردن فیلدهای جدید دارد.

### 2. ویژگی‌های سیستم نظرات

#### برای کاربران:
- ✅ امکان ثبت نظر بدون نیاز به ثبت‌نام
- ✅ نمایش نظرات تایید شده در زیر مقالات
- ✅ فرم ساده با فیلدهای نام، ایمیل و متن نظر
- ✅ اعتبارسنجی ایمیل
- ✅ پیام‌های موفقیت و خطا

#### برای ادمین:
- ✅ پنل مدیریت نظرات در `/admin/comments`
- ✅ فیلتر نظرات بر اساس وضعیت (همه، در انتظار، تایید شده، رد شده)
- ✅ امکان تایید یا رد نظرات
- ✅ امکان حذف نظرات
- ✅ نمایش اطلاعات کامل نظرات شامل IP کاربر

### 3. ساختار فایل‌ها

```
app/
├── api/
│   ├── comments/
│   │   └── route.ts                    # API برای دریافت و ثبت نظرات
│   └── admin/
│       └── comments/
│           ├── route.ts                # API برای دریافت همه نظرات (ادمین)
│           └── [id]/
│               └── route.ts            # API برای بروزرسانی و حذف نظرات
├── components/
│   └── CommentForm.tsx                 # فرم ثبت نظر
└── admin/
    └── comments/
        └── page.tsx                    # صفحه مدیریت نظرات
```

### 4. امنیت

- نظرات جدید با وضعیت `pending` ذخیره می‌شوند
- فقط نظرات تایید شده نمایش داده می‌شوند
- ذخیره IP کاربر برای امنیت
- اعتبارسنجی ورودی‌ها
- Row Level Security (RLS) در دیتابیس

### 5. نحوه استفاده

#### برای کاربران:
1. به صفحه مقاله مورد نظر بروید
2. در بخش "نظرات کاربران" فرم را پر کنید
3. نظر شما پس از تایید ادمین نمایش داده خواهد شد

#### برای ادمین:
1. به پنل مدیریت بروید (`/admin`)
2. روی "نظرات مقالات" کلیک کنید
3. نظرات جدید را بررسی و تایید/رد کنید

### 6. تنظیمات اضافی

#### تغییر متن‌ها:
- متن‌های فارسی در فایل‌های مربوطه قابل تغییر هستند
- پیام‌های موفقیت و خطا در API routes قابل تنظیم هستند

#### تغییر ظاهر:
- استایل‌ها با Tailwind CSS قابل تغییر هستند
- کامپوننت‌های UI از shadcn/ui استفاده می‌کنند

### 7. نکات مهم

- ✅ قبل از استفاده، حتماً فیلدهای جدید را به جدول موجود اضافه کنید
- ✅ اطمینان حاصل کنید که Supabase RLS policies درست تنظیم شده‌اند
- ✅ برای امنیت بیشتر، می‌توانید CAPTCHA اضافه کنید
- ✅ برای جلوگیری از اسپم، می‌توانید محدودیت تعداد نظرات در روز اضافه کنید

### 8. تست سیستم

پس از اجرای اسکریپت SQL:
1. به صفحه مقالات بروید
2. فرم نظر را پر کنید
3. در پنل ادمین نظرات را بررسی کنید
4. نظرات را تایید/رد کنید

### 9. ساختار جدول نهایی

```sql
CREATE TABLE public.comments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  post_id uuid NULL,
  user_id uuid NULL,
  name VARCHAR(255) NOT NULL,
  email VARCHAR(255) NOT NULL,
  content text NOT NULL,
  status text NULL DEFAULT 'pending'::text,
  ip_address VARCHAR(45),
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT comments_pkey PRIMARY KEY (id),
  CONSTRAINT comments_post_id_fkey FOREIGN KEY (post_id) REFERENCES blog_posts (id) ON DELETE CASCADE,
  CONSTRAINT comments_email_check CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
);
``` 