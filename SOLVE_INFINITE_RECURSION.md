# ๐จ ุฑุงูโุญู ูุดฺฉู Infinite Recursion

## ๐จ ูุดฺฉู ุงุตู
ุฎุทุง `infinite recursion detected in policy for relation "auth-users"` ูุดุงู ูโุฏูุฏ ฺฉู ุฏุฑ RLS policies ฺฉ ุญููู ุจโููุงุช ูุฌูุฏ ุฏุงุฑุฏ.

## ๐ ุนูุช ูุดฺฉู
ูุดฺฉู ุฏุฑ policies ุงุฏูู ุงุณุช ฺฉู ุณุน ูโฺฉููุฏ ุจู ุฌุฏูู `auth-users` ุฏุณุชุฑุณ ูพุฏุง ฺฉููุฏุ ุงูุง ุฎูุฏ ุขู ุฌุฏูู ูุฒ RLS ุฏุงุฑุฏ ู ุงู ุจุงุนุซ ุญููู ุจโููุงุช ูโุดูุฏ.

## โ ุฑุงูโุญู ฺฉุงูู

### ูุฑุญูู 1: ุญู ูุดฺฉู infinite recursion
ูุงู `database/fix_infinite_recursion.sql` ุฑุง ุฏุฑ Supabase ุงุฌุฑุง ฺฉูุฏ:

1. ุจู Supabase Dashboard ุจุฑูุฏ
2. SQL Editor ุฑุง ุจุงุฒ ฺฉูุฏ
3. ูุญุชูุง `fix_infinite_recursion.sql` ุฑุง ฺฉูพ ฺฉูุฏ
4. ุงุฌุฑุง ฺฉูุฏ

**ูุชุฌู ููุฑุฏ ุงูุชุธุงุฑ:**
```
โ Infinite recursion fixed successfully!
```

### ูุฑุญูู 2: ุงุถุงูู ฺฉุฑุฏู ฺฉุงุฑุจุฑ ุจู ุนููุงู ุงุฏูู
ูุงู `database/add_user_as_admin_simple.sql` ุฑุง ุงุฌุฑุง ฺฉูุฏ:

1. ุฏุฑ ููุงู SQL Editor
2. ูุญุชูุง ูุงู ุฑุง ฺฉูพ ฺฉูุฏ
3. **ููู**: ุงูู ุฎูุฏ ุฑุง ุฌุงฺฏุฒู ฺฉูุฏ:
   ```sql
   WHERE email = 'your-email@example.com'  -- ุงูู ุฎูุฏ ุฑุง ุงูุฌุง ูุฑุงุฑ ุฏูุฏ
   ```
4. ุงุฌุฑุง ฺฉูุฏ

**ูุชุฌู ููุฑุฏ ุงูุชุธุงุฑ:**
```
โ User added as admin successfully!
```

### ูุฑุญูู 3: ุชุณุช ุณุณุชู
1. ุตูุญู `/admin/teachers` ุฑุง refresh ฺฉูุฏ
2. ุจุงุฏ ูุณุช ูุนููุงู ููุงุด ุฏุงุฏู ุดูุฏ

## ๐ง ุขูฺู ุงุณฺฉุฑูพุช ุงูุฌุงู ูโุฏูุฏ

### ุงุณฺฉุฑูพุช `fix_infinite_recursion.sql`:
1. **ุญุฐู ALL policies ูุดฺฉูโุฏุงุฑ** ุจุฑุง ุฌุฏูู teachers
2. **ุบุฑูุนุงู ฺฉุฑุฏู ูููุช RLS** ุจุฑุง ุญู ูุดฺฉู
3. **ูุนุงู ฺฉุฑุฏู ูุฌุฏุฏ RLS** ุจุง policies ุฌุฏุฏ
4. **ุงุฌุงุฏ policies ุณุงุฏู ู ุงูู** ุจุฏูู recursion

### ุงุณฺฉุฑูพุช `add_user_as_admin_simple.sql`:
1. **ุงุฌุงุฏ ุฌุฏูู admins** (ุงฺฏุฑ ูุฌูุฏ ูุฏุงุฑุฏ)
2. **ุงุถุงูู ฺฉุฑุฏู ฺฉุงุฑุจุฑ ุจู ุนููุงู ุงุฏูู**
3. **ุชุณุช ุฏุณุชุฑุณ**

## ๐งช ุชุณุช ููุง

ูพุณ ุงุฒ ุงุฌุฑุง ูุฑ ุฏู ุงุณฺฉุฑูพุชุ ุงู query ุจุงุฏ ฺฉุงุฑ ฺฉูุฏ:
```sql
SELECT COUNT(*) FROM public.teachers;
```

## ๐ Policies ููุง

ูพุณ ุงุฒ ุงุตูุงุญุ ููุท 4 policy ุฎูุงูุฏ ุฏุงุดุช:
1. **`Simple admin access`** - ุงุฏููโูุง ุจู ุชูุงู ูุนููุงู ุฏุณุชุฑุณ ุฏุงุฑูุฏ (ุจุฏูู recursion)
2. **`Teachers can access own profile`** - ูุนููุงู ููุท ูพุฑููุงู ุฎูุฏ ุฑุง ูโุจููุฏ
3. **`Public read access to teachers`** - ููู ูุนููุงู ูุนุงู ุฑุง ูโุจููุฏ
4. **`Enable insert for new teachers`** - ุซุจุชโูุงู ูุนููุงู ุฌุฏุฏ

## ๐จ ูฺฉุงุช ููู

### ฺุฑุง infinite recursion ุฑุฎ ูโุฏูุฏุ
- Policy ุงุฏูู ุณุน ูโฺฉูุฏ ุจู ุฌุฏูู `auth-users` ุฏุณุชุฑุณ ูพุฏุง ฺฉูุฏ
- ุฌุฏูู `auth-users` ุฎูุฏ ูุฒ RLS ุฏุงุฑุฏ
- ุงู ุจุงุนุซ ุญููู ุจโููุงุช ูโุดูุฏ

### ุฑุงูโุญู:
- ุงุณุชูุงุฏู ุงุฒ ุฌุฏูู `admins` ุจู ุฌุง `auth-users`
- ุงุฌุงุฏ policies ุณุงุฏู ู ูุณุชูู
- ุงุฌุชูุงุจ ุงุฒ queries ูพฺุฏู ุฏุฑ policies

## ๐ ุนุจโุงุจ

### ุงฺฏุฑ ูููุฒ ุฎุทุง ุฏุงุฑุฏ:
1. **Console ูุฑูุฑฺฏุฑ ุฑุง ุจุฑุฑุณ ฺฉูุฏ** (F12 โ Console)
2. **ูุชุงุฌ SQL ุฑุง ุจุฑุฑุณ ฺฉูุฏ**
3. **ูุทูุฆู ุดูุฏ ฺฉู ูุฑ ุฏู ุงุณฺฉุฑูพุช ุงุฌุฑุง ุดุฏูโุงูุฏ**

### ุฎุทุงูุง ุฑุงุฌ:
- **"relation admins does not exist"** โ ุงุณฺฉุฑูพุช ุฏูู ุฑุง ุงุฌุฑุง ฺฉูุฏ
- **"permission denied"** โ ุงุณฺฉุฑูพุช ุงูู ุฑุง ุฏูุจุงุฑู ุงุฌุฑุง ฺฉูุฏ
- **"infinite recursion"** โ ุงุณฺฉุฑูพุช ุงูู ุฑุง ุฏูุจุงุฑู ุงุฌุฑุง ฺฉูุฏ

## ๐ฏ ูุชุฌู ููุง

ูพุณ ุงุฒ ุงุฌุฑุง ุงู ูุฑุงุญู:
- โ ูุดฺฉู infinite recursion ุญู ุดุฏู
- โ Policies ุงูู ู ุณุงุฏู ุงุฌุงุฏ ุดุฏู
- โ ฺฉุงุฑุจุฑ ุดูุง ุงุฏูู ุดุฏู
- โ ุฏุณุชุฑุณ ฺฉุงูู ุจู ูุนููุงู ุฏุงุฑุฏ
- โ ุฏุงุดุจูุฑุฏ ุงุฏูู ฺฉุงุฑ ูโฺฉูุฏ

## ๐ ุฏุฑ ุตูุฑุช ูุดฺฉู

### ุงุทูุงุนุงุช ููุฑุฏ ูุงุฒ:
- ูุชุงุฌ ุงุฌุฑุง ูุฑ ุฏู ุงุณฺฉุฑูพุช
- Console logs ฺฉุงูู
- ุฎุทุงูุง ุฏูู

### ุชูุงุณ ุจุง ูพุดุชุจุงู:
ุชูุงู ุงุทูุงุนุงุช ุจุงูุง ุฑุง ุฌูุนโุขูุฑ ฺฉูุฏ ู ุจู ูู ุงุทูุงุน ุฏูุฏ.
