# سیستم نوتیفیکیشن تماس تصویری معلم

## خلاصه
این سیستم به معلمان اجازه می‌دهد تا تماس‌های تصویری ورودی را در داشبورد خود ببینند و به آنها پاسخ دهند.

## ویژگی‌های اضافه شده

### 1. بخش "تماس‌های تصویری فعال" در داشبورد معلم
- نمایش کلاس‌های تایید شده که ممکن است تماس تصویری داشته باشند
- دکمه "پیوستن به تماس" برای هر کلاس
- نمایش وضعیت کلاس (در انتظار، فعال، پایان یافته)

### 2. نوتیفیکیشن خودکار هنگام شروع تماس
- وقتی دانشجو شروع به تماس می‌کند، نوتیفیکیشن برای معلم ایجاد می‌شود
- معلم می‌تواند از داشبورد خود مستقیماً به تماس بپیوندد

### 3. صفحه video call معلم بهبود یافته
- دریافت اطلاعات booking از URL parameters
- نمایش اطلاعات واقعی دانشجو و کلاس
- سیستم debug برای عیب‌یابی

## نحوه کارکرد

### برای دانشجو:
1. به داشبورد دانشجو بروید (`/dashboard/student`)
2. روی کلاس رزرو شده کلیک کنید
3. در صفحه video call، روی "پیوستن به کلاس" کلیک کنید
4. سیستم به طور خودکار نوتیفیکیشن برای معلم ایجاد می‌کند

### برای معلم:
1. در داشبورد معلم (`/dashboard/teacher`) بخش "تماس‌های تصویری فعال" را ببینید
2. روی دکمه "پیوستن به تماس" کلیک کنید
3. وارد صفحه video call معلم شوید
4. اطلاعات دانشجو و کلاس را مشاهده کنید
5. روی "شروع کلاس آنلاین" کلیک کنید

## فایل‌های تغییر یافته

### 1. `app/dashboard/teacher/page.tsx`
- اضافه شدن state برای `activeVideoCalls`
- تابع `fetchActiveVideoCalls` برای دریافت کلاس‌های فعال
- بخش جدید "تماس‌های تصویری فعال" در tab کلاس‌ها

### 2. `app/teachers/[id]/video-call/page.tsx`
- استفاده از `useSearchParams` برای دریافت booking ID
- دریافت اطلاعات واقعی از Supabase
- سیستم debug و error handling بهبود یافته

### 3. `app/students/[id]/video-call/page.tsx`
- ایجاد نوتیفیکیشن هنگام شروع تماس
- ارسال درخواست به API notifications

### 4. `app/api/notifications/route.ts`
- اضافه شدن متد POST برای ایجاد نوتیفیکیشن جدید

## ساختار URL

### صفحه video call دانشجو:
```
/students/[student-id]/video-call?booking=[booking-id]
```

### صفحه video call معلم:
```
/teachers/[teacher-id]/video-call?booking=[booking-id]
```

## جریان کار کامل

1. **دانشجو** در داشبورد خود روی کلاس کلیک می‌کند
2. **صفحه video call دانشجو** باز می‌شود
3. **دانشجو** روی "پیوستن به کلاس" کلیک می‌کند
4. **سیستم** نوتیفیکیشن برای معلم ایجاد می‌کند
5. **معلم** در داشبورد خود بخش "تماس‌های تصویری فعال" را می‌بیند
6. **معلم** روی "پیوستن به تماس" کلیک می‌کند
7. **صفحه video call معلم** باز می‌شود
8. **هر دو طرف** می‌توانند وارد تماس تصویری شوند

## عیب‌یابی

### اگر معلم نوتیفیکیشن نمی‌بیند:
1. بررسی کنید که جدول `notifications` در Supabase وجود دارد
2. بررسی کنید که API endpoint `/api/notifications` کار می‌کند
3. در console مرورگر خطاها را بررسی کنید

### اگر صفحه video call معلم بارگذاری نمی‌شود:
1. بررسی کنید که URL شامل `?booking=[id]` است
2. بررسی کنید که booking در دیتابیس وجود دارد
3. اطلاعات debug را در صفحه بررسی کنید

## نکات مهم

- **RLS Policies**: اطمینان حاصل کنید که معلمان می‌توانند به جدول `notifications` دسترسی داشته باشند
- **Authentication**: هر دو طرف باید وارد سیستم باشند
- **Real-time Updates**: در نسخه‌های آینده می‌توان از Supabase Realtime استفاده کرد
- **Error Handling**: سیستم به گونه‌ای طراحی شده که حتی در صورت خطا در نوتیفیکیشن، تماس ادامه یابد

## تست کردن

1. **دانشجو** را وارد کنید و به داشبورد بروید
2. **معلم** را در تب دیگری وارد کنید
3. **دانشجو** شروع به تماس کند
4. **معلم** باید نوتیفیکیشن را در داشبورد ببیند
5. **معلم** روی "پیوستن به تماس" کلیک کند
6. **هر دو طرف** باید وارد تماس تصویری شوند

## توسعه‌های آینده

- [ ] نوتیفیکیشن real-time با Supabase Realtime
- [ ] وضعیت آنلاین معلم و دانشجو
- [ ] چت متنی قبل از شروع تماس
- [ ] ضبط جلسه
- [ ] اشتراک‌گذاری فایل
- [ ] تخته سفید تعاملی
